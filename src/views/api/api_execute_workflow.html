<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Modules</title>
    <link rel="stylesheet" href="/assets/css/ubiquitous/body.css">
    <link rel="stylesheet" href="/assets/css/ubiquitous/header.css">
    <link rel="stylesheet" href="/assets/css/ubiquitous/navBar.css">
    <link rel="stylesheet" href="/assets/css/ubiquitous/footer.css">
    <link rel="stylesheet" href="/assets/css/help/help.css">
    <link rel="stylesheet" href="/assets/css/help/api.css">
    
    
</head>
<body>

    <div id="content">

        <!-- INSERT PARTIAL: ubiquitous/header.html -->

        <div id="mainContent">

            <div id="textContent" style="color: rgba(0,0,0,0.9)">

                <div class="subTitle">
                    Programmatic access: TurboPutative website REST API
                </div>

                <div class="subSubTitle">
                    Customized Workflow Execution
                </div>

                <div class="descriptionContent">
                    
                    <div class="text">
                        TurboPutative provides an application programming interface (API)
                        to execute a customized workflow.
                        For this purpose, a POST request must be sent to TurboPutative server
                        specifying three files:

                        <ul class="fileList">
                            <li><a href="/assets/files/defaultParameters/parameters.json" target="_blank">
                                parameters</a>: A JSON file containing the modules that are going to be executed
                                and their corresponding settings.
                            </li>
                            <li><a href="/assets/files/MS_experiment.xls" download>
                                ms_table</a>: An excel table containing candidate metabolites.
                            </li>
                            <li><a href="/assets/files/FeatureInfo.xlsx" download>
                                tm_table</a> (only if TableMerger is selected): An excel table
                                containing additional <i>feature</i> information.</li>
                        </ul>
                    </div>

                    <div class="subSubTitle" style="text-align: justify;">
                        CURL
                    </div>

                    <div class="sssTitle">
                        1) Send job
                    </div>

                    <div class="text">Request:</div>
                    <div class="codeBlock">
                        <code class="codeText">
                            curl -X POST -H "Content-Type: multipart/form-data"
                            -F parameters=@parameters.json
                            -F ms_table=@MS_experiment.xls
                            -F tm_table=@FeatureInfo.xlsx
                            http://turboputative.herokuapp.com/api/execute
                        </code>
                    </div>
                    <br>
                    <div class="text">Response:</div>
                    <div class="codeBlock">
                        <code class="codeText">
                            <pre>
{
    "job_id": "i4mwd"
}</pre>
                        </code>
                    </div>
                    <br>
                    <div class="sssTitle">
                        2) Get job status
                    </div>

                    <div class="text">Request:</div>
                    <div class="codeBlock">
                        <code class="codeText">
                            curl http://turboputative.herokuapp.com/api/execute/status/i4mwd
                        </code>
                    </div>
                    <br>
                    <div class="text">Response:</div>
                    <div class="codeBlock">
                        <code class="codeText">
<pre>
// If job did not finish
{
    "job_id": "i4mwd",
    "status": "WAITING"
}

// If job did finish
{
    "job_id": "i4mwd",
    "status": "READY",
    "downloadURL": "http://turboputative.herokuapp.com/jobs/i4mwd/TurboPutative_results.zip"
}</pre>
                        </code>
                    </div>
                    <br>
                    <div class="sssTitle">
                        3) Download job results
                    </div>

                    <div class="text">Request:</div>
                    <div class="codeBlock">
                        <code class="codeText">
                            curl http://turboputative.herokuapp.com/jobs/i4mwd/TurboPutative_results.zip --output TurboPutative_results.zip
                        </code>
                    </div>
                    <br>
                    <div class="subSubTitle" style="text-align: justify;">
                        PYTHON
                    </div>

                    <div class="codeBlock">
                        <code class="codeText">
<pre>
# Import modules
import sys
import requests
import time

# Set constants
PATH_TO_PARAMETERS_JSON = "/path/to/parameters.json"
PATH_TO_MS_TABLE = "/path/to/MS_experiment.xls"
PATH_TO_TM_TABLE = "/path/to/FeatureInfo.xlsx"

ASYNC = False # If False, it will ask for job status until it is finished


# Main function
def main():
    '''
    Main function
    '''

    # build form as dictionary
    form_data = {
        "parameters": open(PATH_TO_PARAMETERS_JSON, 'rb'),
        "ms_table": open(PATH_TO_MS_TABLE, 'rb'),
        "tm_table": open(PATH_TO_TM_TABLE, 'rb')
    }

    # build url
    host = "http://turboputative.herokuapp.com"
    api = "/api/execute"
    url = host + api

    # send request
    response = requests.post(url, files=form_data)

    # handle error
    if not response.ok:
        print(f"Status code: {response.status_code}")
        print(response.content)
        sys.exit(1)
    
    job_id = response.json()['job_id']
    print(f"Job ID: {job_id}")

    # if async, print job_id and exit script 
    if ASYNC:
        sys.exit(0)
    
    # if not async, ask for job status until finish
    while not ASYNC:
        
        time.sleep(1)
        job_status = requests.get(host + "/api/execute/status/" + job_id).json()

        if job_status["status"] == "WAITING": 
            print("WAITING")
            continue

        elif job_status["status"] == "READY":
            print("READY")
            print("Downloading results")
            job_result = requests.get(job_status['downloadURL'], allow_redirects=True)
            open("TurboPutative_results.zip", 'wb').write(job_result.content)
            sys.exit(0)
        
        else:
            print("ERROR")
            print(job_status)
            sys.exit(1)
        

if __name__ == "__main__":
    main()
</pre>
                        </code>
                    </div>

                    <!-- 
                        - AÑADIR ELEMENTO CON CÓDIGO PONIENDO EJEMPLO DE LA REQUEST
                        CON CURL Y PYTHON
                        - RECUERDA PONER LA RESPUESTA AL ENVIARLO (OTRO BLOQUE) Y 
                        LOS REQUESTS PARA CONSULTAR Y DESCARGAR

                        - VALORA QUITAR O ARREGLAR LOS PARÁMETROS OUTPUT NAME Y COLUMNS...
                     -->

                </div>


            </div>

        </div>

        <!-- INSERT PARTIAL: ubiquitous/footer.html -->

    </div>

</body>

<script>
    document.querySelector("#Help").style.backgroundColor = '#333333';
</script>
</html>